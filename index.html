<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DLX / DMT Repair Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;800&family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #08090a; --bg-column: #101214; --bg-card: #181b1f; --bg-card-hover: #1e2228;
            --text-main: #e8eaed; --text-muted: #6b7280; --border: #1e2228; --border-hover: #2a2f38;
            --c-intake: #c084fc; --c-intake-dim: rgba(192,132,252,0.12);
            --c-shop: #60a5fa; --c-shop-dim: rgba(96,165,250,0.12);
            --c-parts: #fb923c; --c-parts-dim: rgba(251,146,60,0.12);
            --c-done: #4ade80; --c-done-dim: rgba(74,222,128,0.12);
            --c-ready: #22d3ee;
            --c-bulletin: #f472b6; --c-bulletin-dim: rgba(244,114,182,0.12);
            --c-high: #f59e0b; --c-high-dim: rgba(245,158,11,0.10);
            --c-urgent: #ef4444; --c-urgent-dim: rgba(239,68,68,0.10);
            --radius: 10px; --radius-sm: 6px;
            --shadow: 0 1px 3px rgba(0,0,0,0.4); --shadow-lg: 0 8px 32px rgba(0,0,0,0.6);
            --modal-bg: rgba(0,0,0,0.8); --transition: 0.2s cubic-bezier(0.4,0,0.2,1);
        }
        body.light-mode {
            --bg-body: #f1f3f5; --bg-column: #ffffff; --bg-card: #ffffff; --bg-card-hover: #f8f9fa;
            --text-main: #111827; --text-muted: #6b7280; --border: #e5e7eb; --border-hover: #d1d5db;
            --shadow: 0 1px 3px rgba(0,0,0,0.06); --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
            --modal-bg: rgba(255,255,255,0.85);
            --c-intake: #a855f7; --c-intake-dim: rgba(168,85,247,0.08);
            --c-shop: #3b82f6; --c-shop-dim: rgba(59,130,246,0.08);
            --c-parts: #ea580c; --c-parts-dim: rgba(234,88,12,0.08);
            --c-done: #16a34a; --c-done-dim: rgba(22,163,74,0.08);
            --c-bulletin: #db2777; --c-bulletin-dim: rgba(219,39,119,0.08);
            --c-high: #d97706; --c-high-dim: rgba(217,119,6,0.08);
            --c-urgent: #dc2626; --c-urgent-dim: rgba(220,38,38,0.08);
        }
        body.light-mode h1 { background: linear-gradient(135deg,#111,#555); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        body.light-mode .search-input { background: #f1f3f5; color: #111; border-color: #d1d5db; }
        body.light-mode .search-input::placeholder { color: #999; }
        body.light-mode .btn-outline { background: #e5e7eb; color: #111; border-color: #d1d5db; }
        body.light-mode .btn-outline:hover { background: #d1d5db; }
        body.light-mode input, body.light-mode select, body.light-mode textarea { background: #f1f3f5; color: #111; border-color: #d1d5db; }
        body.light-mode .column-count { background: #e5e7eb; color: #111; }
        body.light-mode .vehicle-card:hover { background-color: var(--bg-card-hover); }
        body.light-mode .card-issue { color: #374151; }
        body.light-mode .collapse-toggle { color: #6b7280; }
        body.light-mode .collapse-toggle:hover { color: #111; background: #e5e7eb; }
        body.light-mode .bulletin-panel { background: #fff; border-color: #e5e7eb; }
        body.light-mode .bulletin-msg { background: #f8f9fa; border-color: #e5e7eb; }
        body.light-mode .bulletin-compose textarea, body.light-mode .bulletin-compose input { background: #f1f3f5; border-color: #d1d5db; color: #111; }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        header { background-color: var(--bg-column); padding: 0.8rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        h1 { font-size: 1.25rem; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; background: white; -webkit-background-clip: text; -webkit-text-fill-color: transparent; white-space: nowrap; }
        .controls { display: flex; align-items: center; gap: 0.5rem; }
        .search-input { padding: 0.5rem 0.8rem; border-radius: var(--radius-sm); background: #0d0e10; border: 1px solid var(--border); color: var(--text-main); font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; font-weight: 600; width: 180px; transition: all var(--transition); }
        .search-input:focus { width: 260px; outline: none; border-color: var(--c-shop); box-shadow: 0 0 0 3px rgba(96,165,250,0.15); }
        .search-input::placeholder { color: #444; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; }
        .controls button { padding: 0.5rem 1rem; border: none; border-radius: var(--radius-sm); cursor: pointer; font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; transition: all var(--transition); }
        .btn-primary { background: var(--c-shop); color: white; }
        .btn-primary:hover { filter: brightness(1.15); transform: translateY(-1px); }
        .btn-outline { background: #1a1d21; border: 1px solid #2a2f38; color: #9ca3af; }
        .btn-outline:hover { background: #22262c; color: white; }
        .btn-bulletin { background: var(--c-bulletin-dim); border: 1px solid rgba(244,114,182,0.3); color: var(--c-bulletin); position: relative; }
        .btn-bulletin:hover { background: rgba(244,114,182,0.2); color: #f9a8d4; }
        .btn-bulletin.has-new::after { content: ''; position: absolute; top: 4px; right: 4px; width: 8px; height: 8px; background: var(--c-bulletin); border-radius: 50%; animation: notifPulse 2s ease infinite; }
        @keyframes notifPulse { 0%,100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } }
        .badge-count { font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; font-weight: 800; background: var(--c-bulletin); color: #000; padding: 0px 5px; border-radius: 10px; margin-left: 4px; }

        /* LARGE COLLAPSE BUTTON STYLE */
        .btn-collapse {
            background: #2a2f38; 
            border: 1px solid #444; 
            color: #fff;
            font-size: 0.8rem; 
            padding: 0.5rem 1.2rem;
            letter-spacing: 1px;
        }
        .btn-collapse:hover { background: #333; border-color: #666; }

        .kpi-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.8rem; padding: 0.8rem 1.5rem; flex-shrink: 0; }
        .kpi-card { background: var(--bg-column); padding: 0.8rem 1rem; border-radius: var(--radius); display: flex; align-items: center; gap: 0.8rem; border: 1px solid var(--border); position: relative; overflow: hidden; transition: all var(--transition); }
        .kpi-card:hover { border-color: var(--border-hover); }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
        .kpi-intake::before { background: var(--c-intake); } .kpi-parts::before { background: var(--c-parts); } .kpi-done::before { background: var(--c-done); } .kpi-ready::before { background: var(--c-ready); }
        .kpi-text { display: flex; flex-direction: column; }
        .kpi-value { font-family: 'JetBrains Mono', monospace; font-size: 1.6rem; font-weight: 800; line-height: 1; }
        .kpi-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; letter-spacing: 1px; margin-top: 2px; }

        .kanban-board { flex: 1; min-height: 0; display: flex; justify-content: evenly; gap: 0.8rem; padding: 0 1.5rem 1rem 1.5rem; overflow-x: auto; }
        .kanban-column { background-color: var(--bg-column); border-radius: var(--radius); display: flex; flex-direction: column; height: 100%; border: 1px solid var(--border); justify-content: around; width: 280px; overflow: hidden; transition: border-color 0.2s, box-shadow 0.2s; flex-grow: 1;}
        .kanban-column.collapsed-column { 
            min-width: 60px; 
            flex: 0 0 60px; 
            flex-shrink: 1;
        }
        .kanban-column.collapsed-column .column-content { display: none; }
        .kanban-column.collapsed-column .column-header { 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            padding: 0.8rem 0.4rem;
        }
        .kanban-column.collapsed-column .col-header-left { 
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        .kanban-column.collapsed-column .col-header-left span { 
            display: none; 
        }
        .kanban-column.collapsed-column .column-actions { 
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 0.3rem;
            margin-top: 0.5rem;
        }
        .kanban-column.collapsed-column .column-count { display: none; }
        .kanban-column.collapsed-column .col-dot {
            width: 12px;
            height: 12px;
        }
        .kanban-column.drag-over-column { border-color: var(--c-shop); box-shadow: inset 0 0 20px rgba(96,165,250,0.06); }
        .column-header { padding: 0.8rem 1rem; font-weight: 800; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1.5px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .col-header-left { display: flex; align-items: center; gap: 0.5rem; }
        .col-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .column-count { font-family: 'JetBrains Mono', monospace; background: rgba(255,255,255,0.06); color: var(--text-muted); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 800; }
        .column-actions { display: flex; align-items: center; gap: 0.3rem; }
        .collapse-all-btn { background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 2px 6px; border-radius: 3px; transition: all var(--transition); }
        .collapse-all-btn:hover { color: var(--text-main); background: rgba(255,255,255,0.06); }
        .column-content { padding: 0.6rem; overflow-y: auto; flex: 1; min-height: 60px; scrollbar-width: thin; scrollbar-color: #2a2f38 transparent; }
        .column-content::-webkit-scrollbar { width: 6px; } .column-content::-webkit-scrollbar-track { background: transparent; } .column-content::-webkit-scrollbar-thumb { background: #2a2f38; border-radius: 3px; }

        /* ===== VEHICLE CARD ===== */
        .vehicle-card { background-color: var(--bg-card); border-radius: var(--radius-sm); margin-bottom: 0.5rem; border: 1px solid var(--border); border-left: 4px solid transparent; transition: all var(--transition); overflow: hidden; animation: cardIn 0.3s ease both; position: relative; }
        @keyframes cardIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .vehicle-card:hover { border-color: var(--border-hover); background-color: var(--bg-card-hover); }
        
        .border-complaints { border-left-color: var(--c-intake); }
        .border-ready { border-left-color: var(--c-ready); }
        .border-parts { border-left-color: var(--c-parts); }
        .border-progress { border-left-color: var(--c-shop); }
        .border-returned { border-left-color: var(--c-done); }

        .vehicle-card.dragging { opacity: 0.3; transform: scale(0.97); border-style: dashed; }

        .vehicle-card.priority-high {
            border-color: var(--c-high);
            box-shadow: inset 0 0 0 1px rgba(245,158,11,0.15), 0 0 12px rgba(245,158,11,0.08);
        }
        .vehicle-card.priority-urgent {
            border-color: var(--c-urgent);
            box-shadow: inset 0 0 0 1px rgba(239,68,68,0.2), 0 0 16px rgba(239,68,68,0.12);
            animation: cardIn 0.3s ease both, urgentPulse 3s ease-in-out infinite;
        }
        @keyframes urgentPulse {
            0%, 100% { box-shadow: inset 0 0 0 1px rgba(239,68,68,0.2), 0 0 12px rgba(239,68,68,0.08); }
            50% { box-shadow: inset 0 0 0 1px rgba(239,68,68,0.35), 0 0 20px rgba(239,68,68,0.18); }
        }

        .priority-badge {
            font-family: 'JetBrains Mono', monospace; font-size: 0.5rem; font-weight: 800;
            text-transform: uppercase; letter-spacing: 0.5px; padding: 1px 5px; border-radius: 3px;
        }
        .priority-badge.pb-high { background: var(--c-high-dim); color: var(--c-high); }
        .priority-badge.pb-urgent { background: var(--c-urgent-dim); color: var(--c-urgent); }

        .drag-handle { cursor: grab; display: flex; align-items: center; justify-content: center; padding: 0 4px; color: #333; transition: color var(--transition); flex-shrink: 0; }
        .vehicle-card:hover .drag-handle { color: #666; }
        .drag-handle:active { cursor: grabbing; }
        .drag-handle svg { width: 14px; height: 14px; pointer-events: none; }
        .drop-indicator { height: 3px; background: var(--c-shop); border-radius: 2px; margin: -1px 0; pointer-events: none; box-shadow: 0 0 10px rgba(96,165,250,0.5); animation: dropPulse 1s ease infinite; position: relative; z-index: 10; }
        @keyframes dropPulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
        .card-top-bar { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 0.8rem; cursor: pointer; user-select: none; }
        .card-top-bar:hover .collapse-toggle { opacity: 1; }
        .card-id-group { display: flex; align-items: center; gap: 0.4rem; flex-wrap: wrap; }
        .card-id { font-family: 'JetBrains Mono', monospace; font-weight: 800; font-size: 1rem; color: var(--text-main); }
        .card-condition { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 1px 6px; border-radius: 3px; }
        .cond-operational { background: rgba(74,222,128,0.15); color: var(--c-done); } .cond-warning { background: rgba(251,146,60,0.15); color: var(--c-parts); } .cond-down { background: rgba(248,113,113,0.15); color: #f87171; }
        .card-right { display: flex; align-items: center; gap: 0.5rem; }
        .card-date { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-muted); font-weight: 600; }
        .collapse-toggle { background: none; border: none; cursor: pointer; color: #555; padding: 2px; transition: all var(--transition); opacity: 0.5; display: flex; align-items: center; justify-content: center; border-radius: 3px; width: 22px; height: 22px; }
        .collapse-toggle:hover { color: var(--text-main); opacity: 1; background: rgba(255,255,255,0.06); }
        .collapse-toggle svg { width: 14px; height: 14px; transition: transform var(--transition); }
        .vehicle-card.collapsed .collapse-toggle svg { transform: rotate(-90deg); }
        .card-body { padding: 0 0.8rem 0.6rem; overflow: hidden; max-height: 500px; transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.2s ease; opacity: 1; }
        .vehicle-card.collapsed .card-body { max-height: 0; padding: 0 0.8rem; opacity: 0; }
        .card-issue { font-size: 0.85rem; color: #9ca3af; font-weight: 500; line-height: 1.4; margin-bottom: 0.5rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-meta { display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; }
        .card-pill { font-family: 'JetBrains Mono', monospace; display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .pill-complaints { background: var(--c-intake-dim); color: var(--c-intake); } 
        .pill-ready { background: rgba(34,211,238,0.12); color: var(--c-ready); }
        .pill-parts { background: var(--c-parts-dim); color: var(--c-parts); } 
        .pill-progress { background: var(--c-shop-dim); color: var(--c-shop); }
        .pill-returned { background: var(--c-done-dim); color: var(--c-done); }

        .card-location-row { display: flex; gap: 0.8rem; align-items: center; margin-top: 0.4rem; flex-wrap: wrap; }
        .card-location { font-size: 0.7rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; display: flex; align-items: center; gap: 3px; letter-spacing: 0.3px; }
        .parts-info-block { margin-top: 0.5rem; padding: 0.4rem 0.6rem; background: var(--c-parts-dim); border-radius: 4px; font-size: 0.75rem; }
        .parts-row { display: flex; justify-content: space-between; align-items: center; } .parts-row + .parts-row { margin-top: 2px; }
        .parts-label { font-family: 'JetBrains Mono', monospace; color: var(--text-muted); text-transform: uppercase; font-size: 0.6rem; font-weight: 700; letter-spacing: 0.5px; }
        .parts-val { font-family: 'JetBrains Mono', monospace; color: var(--text-main); font-weight: 700; font-size: 0.75rem; } .parts-val.eta { color: var(--c-parts); }
        .days-badge { font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; font-weight: 700; padding: 1px 5px; border-radius: 3px; background: rgba(255,255,255,0.05); color: var(--text-muted); }
        .days-badge.warn { background: rgba(251,146,60,0.15); color: var(--c-parts); } .days-badge.crit { background: rgba(248,113,113,0.15); color: #f87171; }
        .card-notes { margin-top: 0.6rem; padding: 0.5rem; background: rgba(255,255,255,0.04); border-radius: 4px; font-size: 0.75rem; color: #a1a1aa; font-style: italic; border-left: 2px solid var(--text-muted); }
        body.light-mode .card-notes { background: rgba(0,0,0,0.04); color: #555; }

        /* TYPE BADGES */
        .type-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; font-weight: 700;
            padding: 1px 4px; border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .type-van { background: #3b82f6; color: #fff; border-color: rgba(59, 130, 246, 0.4); }
        .type-prius { background: #10b981; color: #fff; border-color: rgba(16, 185, 129, 0.4); }
        .type-scion { background: #8b5cf6; color: #fff; border-color: rgba(139, 92, 246, 0.4); }
        .type-other { background: #6b7280; color: #fff; border-color: rgba(107, 114, 128, 0.4); }


        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); display: none; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(12px); animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background: var(--bg-column); padding: 1.5rem; border-radius: var(--radius); width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; box-shadow: var(--shadow-lg); border: 1px solid var(--border); animation: slideUp 0.3s cubic-bezier(0.16,1,0.3,1); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-content h2 { font-family: 'JetBrains Mono', monospace; font-size: 1rem; letter-spacing: 2px; margin-bottom: 1.2rem; color: var(--text-main); }
        .form-group { margin-bottom: 1rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
        label { display: block; color: var(--text-muted); font-size: 0.7rem; margin-bottom: 0.3rem; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }
        input, select, textarea { width: 100%; padding: 0.7rem 0.8rem; background-color: #0d0e10; border: 1px solid var(--border); color: var(--text-main); border-radius: var(--radius-sm); font-family: 'Outfit', sans-serif; font-size: 0.95rem; font-weight: 500; transition: all var(--transition); }
        input:focus, select:focus, textarea:focus { border-color: var(--c-shop); outline: none; box-shadow: 0 0 0 3px rgba(96,165,250,0.15); }
        #partsSection { background: var(--c-parts-dim); border: 1px solid rgba(251,146,60,0.25); padding: 0.8rem; border-radius: var(--radius-sm); margin-bottom: 1rem; display: none; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
        .btn-danger { background: rgba(248,113,113,0.15); color: #f87171; border: 1px solid rgba(248,113,113,0.3); font-weight: 700; }
        .btn-danger:hover { background: rgba(248,113,113,0.25); }
        .modal-content::-webkit-scrollbar { width: 6px; } .modal-content::-webkit-scrollbar-track { background: transparent; } .modal-content::-webkit-scrollbar-thumb { background: #2a2f38; border-radius: 3px; }

        #vPriority option[value="High"] { color: var(--c-high); }
        #vPriority option[value="Urgent"] { color: var(--c-urgent); }

        body.wallboard-mode .controls { display: none; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem 1rem; color: var(--text-muted); font-size: 0.8rem; text-align: center; }
        .empty-state svg { opacity: 0.3; margin-bottom: 0.5rem; }
        .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 0.7rem 1.2rem; font-size: 0.85rem; font-weight: 600; color: var(--text-main); box-shadow: var(--shadow-lg); z-index: 200; animation: toastIn 0.3s ease, toastOut 0.3s ease 2.5s forwards; display: flex; align-items: center; gap: 0.5rem; }
        @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; pointer-events: none; } }
        .status-picker-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 150; backdrop-filter: blur(6px); animation: fadeIn 0.15s ease; }
        .status-picker { background: var(--bg-column); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.2rem; min-width: 260px; box-shadow: var(--shadow-lg); animation: slideUp 0.2s cubic-bezier(0.16,1,0.3,1); }
        .status-picker h3 { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); margin-bottom: 0.8rem; }
        .status-picker-btn { display: block; width: 100%; text-align: left; padding: 0.6rem 0.8rem; margin-bottom: 0.3rem; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text-main); font-family: 'Outfit', sans-serif; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all var(--transition); }
        .status-picker-btn:hover { background: var(--bg-card-hover); border-color: var(--c-shop); }
        .status-picker-cancel { display: block; width: 100%; text-align: center; padding: 0.5rem; margin-top: 0.5rem; border: none; background: none; color: var(--text-muted); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; cursor: pointer; }
        .status-picker-cancel:hover { color: var(--text-main); }

        .bulletin-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 90; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .bulletin-overlay.open { opacity: 1; pointer-events: all; }
        .bulletin-panel { position: fixed; top: 0; right: 0; width: 380px; max-width: 90vw; height: 100%; background: var(--bg-column); border-left: 1px solid var(--border); z-index: 95; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.35s cubic-bezier(0.16,1,0.3,1); box-shadow: -8px 0 32px rgba(0,0,0,0.4); }
        .bulletin-panel.open { transform: translateX(0); }
        .bulletin-header { padding: 1rem 1.2rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .bulletin-header h2 { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; color: var(--c-bulletin); }
        .bulletin-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.4rem; padding: 4px; border-radius: 4px; transition: all var(--transition); width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; }
        .bulletin-close:hover { color: var(--text-main); background: rgba(255,255,255,0.06); }
        .bulletin-compose { padding: 1rem 1.2rem; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .compose-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
        .bulletin-compose input[type="text"] { flex: 1; padding: 0.5rem 0.7rem; font-size: 0.8rem; background: #0d0e10; border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-main); font-family: 'Outfit', sans-serif; }
        .bulletin-compose select { padding: 0.5rem; font-size: 0.75rem; width: auto; min-width: 90px; background: #0d0e10; border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-main); }
        .bulletin-compose textarea { width: 100%; padding: 0.6rem 0.7rem; font-size: 0.85rem; min-height: 60px; max-height: 120px; resize: vertical; background: #0d0e10; border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-main); line-height: 1.4; }
        .compose-actions { display: flex; justify-content: flex-end; margin-top: 0.5rem; }
        .btn-post { padding: 0.4rem 1rem; border: none; border-radius: var(--radius-sm); cursor: pointer; font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; background: var(--c-bulletin); color: #000; transition: all var(--transition); }
        .btn-post:hover { filter: brightness(1.15); } .btn-post:disabled { opacity: 0.4; cursor: default; }
        .bulletin-feed { flex: 1; overflow-y: auto; padding: 0.8rem; scrollbar-width: thin; scrollbar-color: #2a2f38 transparent; }
        .bulletin-msg { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 0.8rem; margin-bottom: 0.5rem; transition: all var(--transition); animation: cardIn 0.2s ease both; position: relative; }
        .bulletin-msg:hover { border-color: var(--border-hover); }
        .bulletin-msg-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem; }
        .bulletin-msg-author { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 0.8rem; color: var(--text-main); display: flex; align-items: center; gap: 0.4rem; }
        .bulletin-msg-time { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--text-muted); font-weight: 600; }
        .bulletin-msg-body { font-size: 0.85rem; color: #bbb; line-height: 1.5; word-wrap: break-word; }
        .bulletin-msg-delete { position: absolute; top: 6px; right: 6px; background: none; border: none; color: #444; cursor: pointer; font-size: 0.9rem; padding: 2px 4px; border-radius: 3px; opacity: 0; transition: all var(--transition); }
        .bulletin-msg:hover .bulletin-msg-delete { opacity: 1; }
        .bulletin-msg-delete:hover { color: #f87171; background: rgba(248,113,113,0.1); }
        .bpriority-tag { font-family: 'JetBrains Mono', monospace; font-size: 0.55rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; padding: 1px 5px; border-radius: 3px; }
        .bpriority-info { background: var(--c-shop-dim); color: var(--c-shop); }
        .bpriority-heads-up { background: var(--c-parts-dim); color: var(--c-parts); }
        .bpriority-urgent { background: rgba(248,113,113,0.15); color: #f87171; }
        .bpriority-fyi { background: rgba(255,255,255,0.05); color: var(--text-muted); }
        .bulletin-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem 1rem; color: var(--text-muted); text-align: center; }
        .bulletin-empty-icon { font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem; }
        .bulletin-msg.pinned { border-color: rgba(244,114,182,0.3); background: var(--c-bulletin-dim); }
        .bulletin-msg.pinned .bulletin-msg-body { color: var(--text-main); }
        .pin-btn { background: none; border: none; color: #444; cursor: pointer; font-size: 0.75rem; padding: 2px 4px; border-radius: 3px; transition: all var(--transition); }
        .pin-btn:hover { color: var(--c-bulletin); } .pin-btn.is-pinned { color: var(--c-bulletin); }

        /* ===== MOBILE SWIPER ===== */
        .swiper-nav { display: none; }
        .swiper-dots { display: none; }
.priority-badge.pb-maint { 
    background: rgba(34, 211, 238, 0.15); 
    color: #22d3ee; /* Cyan/Blue for maintenance */
}
.multi-tag {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-size: 0.55rem;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
    background: #3f3f46;
    color: #e4e4e7;
    padding: 1px 5px;
    border-radius: 3px;
    margin-left: 6px;
    border: 1px solid #52525b;
}
.ticket-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-top: 0.5rem;
}
.ticket-row {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 4px;
    padding: 6px 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    border-left: 2px solid transparent;
}
.ticket-row:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}
.ticket-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2px;
}
.ticket-issue {
    font-size: 0.8rem;
    color: var(--text-main);
    font-weight: 500;
    line-height: 1.3;
}
.ticket-meta {
    font-size: 0.65rem;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
    display: flex;
    gap: 8px;
}
/* Visual cues for priority inside the list */
.tr-urgent { border-left-color: var(--c-urgent); }
.tr-high { border-left-color: var(--c-high); }
.tr-maint { border-left-color: var(--c-ready); }
/* Update Urgent to be red text for visibility in dropdown */
#vPriority option[value="Urgent"] { color: #ef4444; font-weight: bold; }
#vPriority option[value="High"] { color: #f59e0b; font-weight: bold; }
#vPriority option[value="Oil Change / Bulb Replacement"] { color: #22d3ee; }

/* ===== HISTORY LOG ===== */
.history-section {
    margin-top: 1.5rem;
    border-top: 1px solid var(--border);
    padding-top: 1rem;
}
.history-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 0.8rem;
    letter-spacing: 1px;
    display: flex;
    justify-content: space-between;
}
.history-list {
    max-height: 150px;
    overflow-y: auto;
    background: #0d0e10;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 0.5rem;
    font-size: 0.7rem;
}
.history-item {
    display: flex;
    gap: 0.5rem;
    padding: 4px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.history-item:last-child { border-bottom: none; }
.h-time { color: var(--text-muted); font-family: 'JetBrains Mono', monospace; flex-shrink: 0; }
.h-user { color: var(--c-shop); font-weight: 700; flex-shrink: 0; }
.h-desc { color: var(--text-main); word-break: break-word; }

.req-line {
    font-size: 0.65rem;
    color: var(--text-muted);
    margin-bottom: 0.2rem;
    display: flex;
    gap: 4px;
}
.req-val { color: var(--text-main); font-weight: 600; }

        @media (max-width: 1200px) {
            header { padding: 0.6rem 0.8rem; flex-wrap: wrap; gap: 0.5rem; }
            h1 { font-size: 1rem; letter-spacing: 1px; }
            .controls { flex-wrap: wrap; gap: 0.4rem; }
            .search-input { width: 100%; order: 10; }
            .search-input:focus { width: 100%; }
            .controls button { padding: 0.4rem 0.7rem; font-size: 0.7rem; }

            .kpi-container { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; padding: 0.5rem 0.8rem; }
            .kpi-card { padding: 0.5rem 0.7rem; }
            .kpi-value { font-size: 1.3rem; }
            .kpi-label { font-size: 0.6rem; }

            /* Swiper layout */
            .kanban-board {
                display: flex;
                flex-direction: row;
                grid-template-columns: none; /* Clear desktop grid layout */
                overflow: hidden;
                padding: 0;
                gap: 0;
                position: relative;
                touch-action: pan-y;
            }
            .kanban-column {
                min-width: 100%;
                width: 100%;
                flex-shrink: 0;
                border-radius: 0;
                border: none;
                border-top: 1px solid var(--border);
                transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            }
            .column-header {
                position: sticky;
                top: 0;
                z-index: 5;
                background: var(--bg-column);
                padding: 0.6rem 0.8rem;
            }
            .column-content { padding: 0.5rem 0.8rem; }

            /* Swiper navigation arrows */
            .swiper-nav {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0 0.8rem;
                flex-shrink: 0;
                gap: 0.5rem;
            }
            .swiper-arrow {
                background: var(--bg-column);
                border: 1px solid var(--border);
                color: var(--text-main);
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                font-size: 1.1rem;
                font-weight: 800;
                transition: all var(--transition);
                flex-shrink: 0;
                -webkit-tap-highlight-color: transparent;
            }
            .swiper-arrow:active { transform: scale(0.9); background: var(--bg-card-hover); }
            .swiper-arrow:disabled { opacity: 0.2; pointer-events: none; }

            /* Dot indicators */
            .swiper-dots {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 6px;
                flex: 1;
            }
            .swiper-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--border-hover);
                border: none;
                padding: 0;
                cursor: pointer;
                transition: all 0.3s ease;
                -webkit-tap-highlight-color: transparent;
                position: relative;
            }
            .swiper-dot::after {
                content: attr(data-count);
                position: absolute;
                top: -18px;
                left: 50%;
                transform: translateX(-50%);
                font-family: 'JetBrains Mono', monospace;
                font-size: 0.55rem;
                font-weight: 800;
                color: var(--text-muted);
                opacity: 0;
                transition: opacity 0.2s;
                white-space: nowrap;
            }
            .swiper-dot.active {
                width: 24px;
                border-radius: 4px;
                transform: scaleY(1.1);
            }
            .swiper-dot.active::after { opacity: 1; }
            .swiper-dot:nth-child(1) { background: var(--c-intake); }
            .swiper-dot:nth-child(2) { background: var(--c-ready); }
            .swiper-dot:nth-child(3) { background: var(--c-parts); }
            .swiper-dot:nth-child(4) { background: var(--c-shop); }
            .swiper-dot:nth-child(5) { background: var(--c-done); }
            .swiper-dot:not(.active) { opacity: 0.35; }

            /* Swiper column label shown below dots */
            .swiper-label {
                font-family: 'JetBrains Mono', monospace;
                font-size: 0.65rem;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 1px;
                color: var(--text-muted);
                text-align: center;
                padding: 0.2rem 0 0.3rem;
                transition: color 0.3s;
            }

            /* Hide drag handles on mobile */
            .drag-handle { display: none; }
            .vehicle-card { cursor: pointer; }

            .toast { bottom: 4.5rem; right: 0.8rem; left: 0.8rem; justify-content: center; }
        }

        /* Light mode swiper overrides */
        body.light-mode .swiper-arrow { background: #fff; border-color: #d1d5db; color: #111; }
        body.light-mode .swiper-arrow:active { background: #e5e7eb; }
        body.light-mode .swiper-dot:not(.active) { opacity: 0.25; }
    </style>
</head>
<body>
    <header>
        <h1>DLX / DMT Repair Tracker</h1>
        <div class="controls">
            <input type="text" id="searchInput" class="search-input" placeholder="Search unitâ€¦" onkeyup="renderBoard()">
            <button class="btn-collapse" onclick="toggleGlobalCollapse()">âŠŸ COLLAPSE ALL</button>
            <button class="btn-primary" onclick="openModal('add')">+ Add Unit</button>
            <button class="btn-bulletin" id="bulletinToggle" onclick="toggleBulletin()">ðŸ“Œ Board <span class="badge-count" id="msgCount" style="display:none">0</span></button>
            <button class="btn-outline" onclick="toggleTheme()">â—‘ Theme</button>
            <button class="btn-outline" onclick="toggleWallboardMode()">â–£ Wall</button>
        </div>
    </header>
    <div class="kpi-container">
        <div class="kpi-card kpi-intake"><div class="kpi-text"><span class="kpi-value" id="kpi-total" style="color:var(--c-intake)">0</span><span class="kpi-label">Reported</span></div></div>
        <div class="kpi-card kpi-ready"><div class="kpi-text"><span class="kpi-value" id="kpi-ready" style="color:var(--c-ready)">0</span><span class="kpi-label">For Pickup</span></div></div>
        <div class="kpi-card kpi-parts"><div class="kpi-text"><span class="kpi-value" id="kpi-parts" style="color:var(--c-parts)">0</span><span class="kpi-label">Parts Hold / Diagnostics</span></div></div>
        <div class="kpi-card kpi-done"><div class="kpi-text"><span class="kpi-value" id="kpi-complete" style="color:var(--c-done)">0</span><span class="kpi-label">Complete</span></div></div>
    </div>
    
    <div class="swiper-nav" id="swiperNav">
        <button class="swiper-arrow" id="swiperPrev" onclick="swiperGo(-1)">â€¹</button>
        <div class="swiper-dots" id="swiperDots"></div>
        <button class="swiper-arrow" id="swiperNext" onclick="swiperGo(1)">â€º</button>
    </div>

    <div class="kanban-board" id="kanbanBoard">
        <div class="kanban-column" data-col-type="on_the_road">
            <div class="column-header">
                <div class="col-header-left">
                    <div class="col-dot" style="background:#a78bfa"></div>
                    <span style="color:#a78bfa">On the Road</span>
                </div>
                <div class="column-actions">
                    <button class="collapse-all-btn" onclick="toggleCollapseAll('col-on-the-road')">âŠŸ</button>
                    <button class="collapse-all-btn" onclick="toggleColumnCollapse(this)" title="Collapse column">âˆ’</button>
                    <span class="column-count" id="count-col-road">0</span>
                </div>
            </div>
            <div class="column-content" id="col-on-the-road" data-col="on_the_road"></div>
        </div>

        <div class="kanban-column">
            <div class="column-header">
                <div class="col-header-left">
                    <div class="col-dot" style="background:var(--c-intake)"></div>
                    <span style="color:var(--c-intake)">Repair Complaints</span>
                </div>
                <div class="column-actions">
                    <button class="collapse-all-btn" onclick="toggleCollapseAll('col-complaints')">âŠŸ</button>
                    <button class="collapse-all-btn" onclick="toggleColumnCollapse(this)" title="Collapse column">âˆ’</button>
                    <span class="column-count" id="count-col-1">0</span>
                </div>
            </div>
            <div class="column-content" id="col-complaints" data-col="complaints"></div>
        </div>

        <div class="kanban-column">
            <div class="column-header">
                <div class="col-header-left">
                    <div class="col-dot" style="background:var(--c-ready)"></div>
                    <span style="color:var(--c-ready)">Ready for Pick Up</span>
                </div>
                <div class="column-actions">
                    <button class="collapse-all-btn" onclick="toggleCollapseAll('col-ready')">âŠŸ</button>
                    <button class="collapse-all-btn" onclick="toggleColumnCollapse(this)" title="Collapse column">âˆ’</button>
                    <span class="column-count" id="count-col-2">0</span>
                </div>
            </div>
            <div class="column-content" id="col-ready" data-col="ready"></div>
        </div>

        <div class="kanban-column">
            <div class="column-header">
                <div class="col-header-left">
                    <div class="col-dot" style="background:var(--c-parts)"></div>
                    <span style="color:var(--c-parts)">Parts Hold / Diagnostics</span>
                </div>
                <div class="column-actions">
                    <button class="collapse-all-btn" onclick="toggleCollapseAll('col-parts')">âŠŸ</button>
                    <button class="collapse-all-btn" onclick="toggleColumnCollapse(this)" title="Collapse column">âˆ’</button>
                    <span class="column-count" id="count-col-3">0</span>
                </div>
            </div>
            <div class="column-content" id="col-parts" data-col="parts"></div>
        </div>

        <div class="kanban-column">
            <div class="column-header">
                <div class="col-header-left">
                    <div class="col-dot" style="background:var(--c-shop)"></div>
                    <span style="color:var(--c-shop)">In Progress</span>
                </div>
                <div class="column-actions">
                    <button class="collapse-all-btn" onclick="toggleCollapseAll('col-progress')">âŠŸ</button>
                    <button class="collapse-all-btn" onclick="toggleColumnCollapse(this)" title="Collapse column">âˆ’</button>
                    <span class="column-count" id="count-col-4">0</span>
                </div>
            </div>
            <div class="column-content" id="col-progress" data-col="progress"></div>
        </div>

        <div class="kanban-column">
            <div class="column-header">
                <div class="col-header-left">
                    <div class="col-dot" style="background:var(--c-done)"></div>
                    <span style="color:var(--c-done)">Returned to Dispatch</span>
                </div>
                <div class="column-actions">
                    <button class="collapse-all-btn" onclick="toggleCollapseAll('col-returned')">âŠŸ</button>
                    <button class="collapse-all-btn" onclick="toggleColumnCollapse(this)" title="Collapse column">âˆ’</button>
                    <span class="column-count" id="count-col-5">0</span>
                </div>
            </div>
            <div class="column-content" id="col-returned" data-col="returned"></div>
        </div>
    </div>

    <div class="bulletin-overlay" id="bulletinOverlay" onclick="toggleBulletin()"></div>
    <div class="bulletin-panel" id="bulletinPanel">
        <div class="bulletin-header"><h2>ðŸ“Œ Bulletin Board</h2><button class="bulletin-close" onclick="toggleBulletin()">âœ•</button></div>
        <div class="bulletin-compose">
            <div class="compose-row"><input type="text" id="msgAuthor" placeholder="Your nameâ€¦" maxlength="30"><select id="msgPriority"><option value="fyi">FYI</option><option value="info" selected>Info</option><option value="heads-up">Heads Up</option><option value="urgent">Urgent</option></select></div>
            <textarea id="msgBody" placeholder="Post a message to the boardâ€¦" maxlength="500"></textarea>
            <div class="compose-actions"><button class="btn-post" id="postBtn" onclick="postMessage()" disabled>Post</button></div>
        </div>
        <div class="bulletin-feed" id="bulletinFeed"></div>
    </div>
    
    <div id="entryModal" class="modal-overlay" onclick="if(event.target===this)closeModal()">
        <div class="modal-content">
            <h2 id="modalTitle">EDIT UNIT</h2>
            <form id="vehicleForm" onsubmit="saveVehicle(event)">
                <input type="hidden" id="mode" value="add"><input type="hidden" id="targetRowIndex" value=""><input type="hidden" id="vHistory" value="">
                
                <div class="form-group" style="background:rgba(255,255,255,0.03); padding:0.5rem; border-radius:6px;">
                    <label style="color:var(--c-shop);">Who are you? (For Logs)</label>
                    <input type="text" id="currentUser" placeholder="Enter your name..." onchange="localStorage.setItem('dlx_username', this.value)" required>
                </div>
                <hr style="border:0; border-top:1px solid var(--border); margin:1rem 0;">

                <div class="form-row">
                    <div class="form-group"><label>Vehicle ID</label><input type="text" id="vID" required></div>
                    
                    <div class="form-group">
                        <label>Vehicle Type</label>
                        <select id="vType">
                            <option value="">Select Type...</option>
                            <option value="Van">Van</option>
                            <option value="Prius">Prius</option>
                            <option value="Scion">Scion</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group"><label>Priority</label>
                        <select id="vPriority">
                            <option value="Urgent">ðŸ”´ Urgent</option>
                            <option value="High">âš  High</option>
                            <option value="Oil Change / Bulb Replacement">ðŸ”§ Oil Change / Bulb</option>
                            <option value="Normal" selected>Normal Priority</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Condition</label><select id="vStatus"><option value="Operational">Operational</option><option value="Warning">Warning</option><option value="Down">Down</option></select></div>
                </div>

                <div class="form-row">
                    <div class="form-group"><label>Home Location</label><input type="text" id="vHomeLocation" placeholder="e.g. Bend, Salemâ€¦"></div>
                    <div class="form-group"><label>Requested By</label><input type="text" id="vRequestedBy" placeholder="Dispatcher Name"></div>
                </div>
                
                <div class="form-group"><label>Issue</label><input type="text" id="vIssue" required></div>
                
                <div class="form-group"><label>Notes / Updates</label><textarea id="vNotes" rows="3" placeholder="Enter updates hereâ€¦"></textarea></div>

                <div class="form-row">
                    <div class="form-group"><label>Current Location</label><select id="vLocation"><option value="Dispatch Lot">Dispatch Lot</option><option value="On the road">On the road</option><option value="Pam (Ridesource, DMV)">Pam (Ridesource, DMV)</option><option value="Shop">Shop</option><option value="Paint">Paint</option><option value="Glass">Glass</option></select></div>
                    <div class="form-group"><label>Shop Status</label>
                        <select id="vShopStatus" onchange="togglePartsFields()">
		
                            <option value="Reported">Reported</option>
                            <option value="Ready for Pickup">Ready for Pickup</option>
                            <option value="Received">Received</option>
                            <option value="Assessment">Assessment</option>
                            <option value="Repair in Progress">Repair in Progress</option>
                            <option value="Awaiting part order">Awaiting part order</option>
                            <option value="Parts Received - Waiting for Technician">Parts Received - Waiting for Technician</option>
                            <option value="Complete">Complete</option>
                            <option value="Ready for Delivery">Ready for Delivery</option>
                        </select>
                    </div>
                </div>
<div class="form-group">
    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
        <input type="checkbox" id="vOnTheRoad" style="width: auto; margin: 0;">
        <span>On the Road (tracked separately from status)</span>
    </label>
</div>
                <div id="partsSection"><div class="form-group"><label>Date Parts Ordered</label><input type="date" id="vPartsOrdered"></div><div class="form-group" style="margin-bottom:0;"><label>Estimated Delivery (ETA)</label><input type="date" id="vPartsEta"></div></div>
                <div class="form-group"><label>Date In</label><input type="date" id="vDate" required></div>
                
                <div class="form-group"><label>Ridesource Inspection Date</label><input type="date" id="vInspectionDate"></div>
                
                <div class="history-section" id="historySection">
                    <div class="history-title"><span>Activity Log</span> <span id="lastUpdatedBy" style="color:var(--text-main)"></span></div>
                    <div class="history-list" id="historyList"></div>
                </div>

                <div class="modal-actions">
                    <button type="button" id="deleteBtn" class="controls btn-danger" style="display:none;" onclick="deleteCurrent()">DELETE</button>
                    <button type="button" class="btn-outline" onclick="closeModal()">CANCEL</button>
                    <button type="submit" class="btn-primary" id="saveBtn">SAVE</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxVv34BESHIyT_-HohJ-gUc4a2QdQdwHOzEmxFtr1WFxjwV620spd3KnjyHd8If5HSfYQ/exec"; 
        let fleetData = [], collapsedCards = new Set();
        
        const  COLUMN_STATUSES = { 
    				on_the_road: [],  // Empty - filled by onTheRoad boolean, not status
    				complaints: ["Reported"],
	       ready:      ["Ready for Pickup"],
 				   parts:      ["Awaiting part order", "Assessment"],
		    progress:   ["Received", "Parts Received - Waiting for Technician", "Repair in Progress"], 
		    returned:   ["Complete"] 
}
        function statusToCol(status, onTheRoad) {
    // If onTheRoad flag is true, route to on_the_road column
    if (onTheRoad === true) {
        return 'on_the_road';
    }
    
    // Otherwise use normal status-based routing
    for (const [c, sts] of Object.entries(COLUMN_STATUSES)) { 
        if (sts.includes(status)) return c; 
    } 
    return 'complaints'; 
}

        // ==================== GLOBAL COLLAPSE LOGIC ====================
        function toggleGlobalCollapse() {
            const cards = document.querySelectorAll('.vehicle-card');
            const anyOpen = [...cards].some(c => !c.classList.contains('collapsed'));
            
            cards.forEach(c => {
                const k = c.dataset.cardKey;
                if(anyOpen) {
                    c.classList.add('collapsed');
                    collapsedCards.add(k);
                } else {
                    c.classList.remove('collapsed');
                    collapsedCards.delete(k);
                }
            });
        }

        // ==================== HISTORY LOGIC ====================
        function getUsername() {
            return document.getElementById('currentUser').value.trim() || "Unknown";
        }

        function createLogEntry(action, desc) {
            return {
                ts: Date.now(),
                user: getUsername(),
                action: action,
                desc: desc
            };
        }

        function parseHistory(jsonStr) {
            try { return jsonStr ? JSON.parse(jsonStr) : []; } catch(e) { return []; }
        }

        function renderHistoryLog(historyArray) {
            const list = document.getElementById('historyList');
            if(!historyArray || historyArray.length === 0) {
                list.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:10px;">No history recorded</div>';
                return;
            }
            const sorted = [...historyArray].sort((a,b) => b.ts - a.ts);
            
            list.innerHTML = sorted.map(h => {
                const date = new Date(h.ts);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                return `
                <div class="history-item">
                    <div class="h-time">${timeStr}</div>
                    <div class="h-user">${h.user}:</div>
                    <div class="h-desc">${h.desc}</div>
                </div>`;
            }).join('');
        }

        // ==================== MOBILE SWIPER ====================
        const COLUMN_NAMES = ['On Road', 'Complaints', 'Ready', 'Parts', 'In Progress', 'Returned'];
        const COLUMN_COLORS = ['#a78bfa', 'var(--c-intake)', 'var(--c-ready)', 'var(--c-parts)', 'var(--c-shop)', 'var(--c-done)'];
        let swiperIndex = 0;
        let touchStartX = 0, touchStartY = 0, touchDeltaX = 0, isSwiping = false, swipeStartTime = 0;
        const SWIPE_THRESHOLD = 50;
        const SWIPE_VELOCITY_THRESHOLD = 0.3;

        function isMobile() {
            return window.innerWidth <= 1200;
        }

        function initSwiperDots() {
            const dotsContainer = document.getElementById('swiperDots');
            dotsContainer.innerHTML = '';
            for (let i = 0; i < 6; i++) {
                const dot = document.createElement('button');
                dot.className = 'swiper-dot' + (i === swiperIndex ? ' active' : '');
                dot.dataset.count = '';
                dot.onclick = () => swiperGoTo(i);
                dotsContainer.appendChild(dot);
            }
            updateSwiperUI();
        }

        function updateSwiperUI() {
            if (!isMobile()) return;
            const dots = document.querySelectorAll('.swiper-dot');
            const columns = document.querySelectorAll('.kanban-column');
            const counts = [
                document.getElementById('count-col-road').textContent,
                document.getElementById('count-col-1').textContent,
                document.getElementById('count-col-2').textContent,
                document.getElementById('count-col-3').textContent,
                document.getElementById('count-col-4').textContent,
                document.getElementById('count-col-5').textContent,
            ];

            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === swiperIndex);
                dot.dataset.count = counts[i];
            });

            columns.forEach((col, i) => {
                col.style.transform = `translateX(${-swiperIndex * 100}%)`;
            });

            document.getElementById('swiperPrev').disabled = swiperIndex === 0;
            document.getElementById('swiperNext').disabled = swiperIndex === 5;
        }

        function swiperGo(dir) {
            const next = swiperIndex + dir;
            if (next < 0 || next > 5) return;
            swiperGoTo(next);
        }

        function swiperGoTo(idx) {
            swiperIndex = Math.max(0, Math.min(5, idx));
            updateSwiperUI();
        }

        // Touch handlers for swipe
        function onTouchStart(e) {
            if (!isMobile()) return;
            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            touchDeltaX = 0;
            isSwiping = false;
            swipeStartTime = Date.now();
        }

        function onTouchMove(e) {
            if (!isMobile()) return;
            const touch = e.touches[0];
            const deltaX = touch.clientX - touchStartX;
            const deltaY = touch.clientY - touchStartY;

            if (!isSwiping && Math.abs(deltaX) > 10) {
                if (Math.abs(deltaX) > Math.abs(deltaY) * 1.2) {
                    isSwiping = true;
                }
            }

            if (isSwiping) {
                e.preventDefault();
                touchDeltaX = deltaX;
                const columns = document.querySelectorAll('.kanban-column');
                const pct = (touchDeltaX / window.innerWidth) * 100;
                columns.forEach((col, i) => {
                    col.style.transition = 'none';
                    col.style.transform = `translateX(${-swiperIndex * 100 + pct}%)`;
                });
            }
        }
        function onTouchEnd(e) {
            if (!isMobile() || !isSwiping) return;

            const elapsed = Date.now() - swipeStartTime;
            const velocity = Math.abs(touchDeltaX) / elapsed;

            const columns = document.querySelectorAll('.kanban-column');
            columns.forEach(col => {
                col.style.transition = 'transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            });

            if (Math.abs(touchDeltaX) > SWIPE_THRESHOLD || velocity > SWIPE_VELOCITY_THRESHOLD) {
                if (touchDeltaX > 0 && swiperIndex > 0) {
                    swiperIndex--;
                } else if (touchDeltaX < 0 && swiperIndex < 4) {
                    swiperIndex++;
                }
            }

            updateSwiperUI();
            isSwiping = false;
            touchDeltaX = 0;
        }

        const kanbanBoard = document.getElementById('kanbanBoard');
        kanbanBoard.addEventListener('touchstart', onTouchStart, { passive: true });
        kanbanBoard.addEventListener('touchmove', onTouchMove, { passive: false });
        kanbanBoard.addEventListener('touchend', onTouchEnd, { passive: true });

        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (isMobile()) {
                    updateSwiperUI();
                } else {
                    document.querySelectorAll('.kanban-column').forEach(col => {
                        col.style.transform = '';
                        col.style.transition = '';
                    });
                }
            }, 150);
        });

        // ==================== DRAG & DROP ====================
        let draggedRowIndex = null, draggedEl = null, currentIndicator = null;
        function clearIndicators() { document.querySelectorAll('.drop-indicator').forEach(e=>e.remove()); document.querySelectorAll('.drag-over-column').forEach(e=>e.classList.remove('drag-over-column')); currentIndicator = null; }
        function onDragStart(e, rowIndexes) {
            if (isMobile()) { e.preventDefault(); return; }
            const indexes = Array.isArray(rowIndexes) ? rowIndexes : [rowIndexes];
            e.dataTransfer.setData('text/plain', JSON.stringify(indexes));
            draggedEl = e.target.closest('.vehicle-card');
            draggedEl.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            const g = document.createElement('div');
            g.style.cssText = 'position:absolute;top:-1000px;';
            document.body.appendChild(g);
            e.dataTransfer.setDragImage(g, 0, 0);
            setTimeout(() => g.remove(), 0);
        }
        function onDragEnd() { if (draggedEl) { draggedEl.classList.remove('dragging'); draggedEl.style.opacity = ''; } draggedRowIndex = null; draggedEl = null; clearIndicators(); }
        function getClosestCard(col, y) { const cards = [...col.querySelectorAll('.vehicle-card:not(.dragging)')]; let closest = null, co = Number.NEGATIVE_INFINITY; for (const c of cards) { const b = c.getBoundingClientRect(), o = y - b.top - b.height / 2; if (o < 0 && o > co) { co = o; closest = c; } } return closest; }
        function onDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; const cc = e.target.closest('.column-content'); if (!cc) return; document.querySelectorAll('.drag-over-column').forEach(e => e.classList.remove('drag-over-column')); cc.closest('.kanban-column').classList.add('drag-over-column'); const cl = getClosestCard(cc, e.clientY); if (currentIndicator) currentIndicator.remove(); const ind = document.createElement('div'); ind.className = 'drop-indicator'; currentIndicator = ind; if (cl) cc.insertBefore(ind, cl); else cc.appendChild(ind); }
        function onDrop(e) {
    e.preventDefault();
    const cc = e.target.closest('.column-content');
    let draggedIndexes;
    try { draggedIndexes = JSON.parse(e.dataTransfer.getData('text/plain')); } catch (err) { clearIndicators(); return; }
    if (!cc || !draggedIndexes || draggedIndexes.length === 0) { clearIndicators(); return; }

    const targetColType = cc.dataset.col;
    const firstVeh = fleetData.find(v => v.rowIndex == draggedIndexes[0]);
    if (!firstVeh) { clearIndicators(); return; }
    const sc = statusToCol(firstVeh.shopStatus || "Reported", firstVeh.onTheRoad);

    if (sc === targetColType) {
        if (draggedEl && currentIndicator) cc.insertBefore(draggedEl, currentIndicator);
        else if (draggedEl) cc.appendChild(draggedEl);
        if (draggedEl) { draggedEl.classList.remove('dragging'); draggedEl.style.opacity = ''; }
        clearIndicators();
        persistColumnOrder(cc);
    } else {
        clearIndicators();
        
        // ===== NEW LOGIC =====
        // If dragging FROM "on_the_road" column, uncheck the flag automatically
        // Don't show status picker popup
        if (sc === 'on_the_road') {
            const user = getUsername();
            showToast(`âŸ³ Unchecking "On the Road" and moving to ${targetColType}...`);
            
            const updates = draggedIndexes.map(idx => {
                const v = fleetData.find(f => f.rowIndex === idx);
                if (!v) return Promise.resolve();
                
                // Uncheck the onTheRoad flag
                v.onTheRoad = false;
                
                // Get the first possible status for target column
                const targetStatus = COLUMN_STATUSES[targetColType][0];
                if (targetStatus) {
                    v.shopStatus = targetStatus;
                }
                
                const payload = {
                    action: 'update',
                    rowIndex: v.rowIndex,
                    user: user,
                    id: v.id,
                    status: v.status,
                    issue: v.issue,
                    date: v.date,
                    shopStatus: targetStatus || v.shopStatus,
                    location: v.location,
                    partsOrdered: v.partsOrdered || '',
                    partsEta: v.partsEta || '',
                    priority: v.priority || 'Normal',
                    homeLocation: v.homeLocation || '',
                    notes: v.notes || '',
                    requestedBy: v.requestedBy || '',
                    vehicleType: v.vehicleType || '',
                    onTheRoad: false  // â† Uncheck flag
                };
                return fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) })
                    .catch(err => {
                        console.error("Drag update failed:", err);
                        showToast("âŒ Failed to update - check connection");
                    });
            });

            Promise.all(updates).then(() => {
                showToast(`âœ“ Moved by ${user}`);
                setTimeout(fetchSheetData, 800);
            }).catch(err => console.error("Promise.all error:", err));
            renderBoard(); 
            return;  // â† EXIT HERE - don't show popup
        }
        // ===== END NEW LOGIC =====

        const possibleStatuses = COLUMN_STATUSES[targetColType];
        
        const moveUser = getUsername();
        
        const applyStatusToAll = (newStatus) => {
            const user = getUsername();
            showToast(`âŸ³ Moving ${draggedIndexes.length} tickets to ${newStatus}...`);
            const updates = draggedIndexes.map(idx => {
                const v = fleetData.find(f => f.rowIndex === idx);
                if (!v) return Promise.resolve();
                
                v.shopStatus = newStatus; 

                const payload = {
                    action: 'update',
                    rowIndex: v.rowIndex,
                    user: user,
                    id: v.id,
                    status: v.status,
                    issue: v.issue,
                    date: v.date,
                    shopStatus: newStatus,
                    location: v.location,
                    partsOrdered: v.partsOrdered || '',
                    partsEta: v.partsEta || '',
                    priority: v.priority || 'Normal',
                    homeLocation: v.homeLocation || '',
                    notes: v.notes || '',
                    requestedBy: v.requestedBy || '',
                    vehicleType: v.vehicleType || '',
                    onTheRoad: v.onTheRoad  // â† Preserve onTheRoad flag
                };
                return fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) })
                    .catch(err => {
                        console.error("Drag update failed:", err);
                        showToast("âŒ Failed to update - check connection");
                    });
            });

            Promise.all(updates).then(() => {
                showToast(`âœ“ Moved by ${user}`);
                setTimeout(fetchSheetData, 800);
            }).catch(err => console.error("Promise.all error:", err));
            renderBoard(); 
        };

        if (possibleStatuses.length === 1) {
            applyStatusToAll(possibleStatuses[0]);
        } else {
            showStatusPickerMulti(firstVeh.id, possibleStatuses, applyStatusToAll);
        }
    }
}
        function persistColumnOrder(cc) { 
            const cards = cc.querySelectorAll('.vehicle-card'), items = []; 
            cards.forEach((c, i) => { 
                const ri = parseInt(c.dataset.rowIndex); 
                if (!ri) return; 
                items.push({ rowIndex: ri, sortOrder: i + 1 }); 
                const veh = fleetData.find(v => v.rowIndex === ri); 
                if (veh) veh.sortOrder = i + 1; 
            }); 
            if (!items.length) return; 
            showToast("â†• Saving orderâ€¦"); 
            fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "reorder", items, user: getUsername() }) })
                .then(() => showToast("âœ“ Order saved"))
                .catch(err => console.error("Reorder failed:", err)); 
        }
        
        function showStatusPickerMulti(vehId, statuses, callback) {
            document.querySelectorAll('.status-picker-overlay').forEach(e => e.remove());
            const ol = document.createElement('div');
            ol.className = 'status-picker-overlay';
            ol.onclick = e => { if (e.target === ol) ol.remove(); };
            const pk = document.createElement('div');
            pk.className = 'status-picker';
            pk.innerHTML = `<h3>Set status for ${vehId}</h3>`;
            statuses.forEach(s => {
                const b = document.createElement('button');
                b.className = 'status-picker-btn';
                b.textContent = s;
                b.onclick = () => { ol.remove(); callback(s); };
                pk.appendChild(b);
            });
            const c = document.createElement('button');
            c.className = 'status-picker-cancel';
            c.textContent = 'Cancel';
            c.onclick = () => ol.remove();
            pk.appendChild(c);
            ol.appendChild(pk);
            document.body.appendChild(ol);
        }

        document.querySelectorAll('.column-content').forEach(col => { col.addEventListener('dragover', onDragOver); col.addEventListener('dragleave', e => { if (!col.contains(e.relatedTarget)) { col.closest('.kanban-column').classList.remove('drag-over-column'); if (currentIndicator && col.contains(currentIndicator)) { currentIndicator.remove(); currentIndicator = null; } } }); col.addEventListener('drop', onDrop); });

        // ==================== DATA ====================
        async function fetchSheetData() { if (SCRIPT_URL.includes("PASTE_YOUR")) { document.querySelector('.kanban-board').innerHTML = `<div style="grid-column:1/-1;display:flex;align-items:center;justify-content:center;color:#f87171;">âš ï¸ Paste your Apps Script URL</div>`; return; } try { const r = await fetch(SCRIPT_URL); const d = await r.json(); if (Array.isArray(d) && d.length > 0 && Array.isArray(d[0])) { showToast("âš ï¸ Script mismatch â€” redeploy"); return; } fleetData = d; renderBoard(); } catch (e) { console.error(e); showToast("âŒ Failed to load data"); } }
        function formatDate(s) { if (!s) return ''; const p = s.split('-'); return p.length === 3 ? `${p[1]}/${p[2]}/${p[0]}` : s; }
        function daysElapsed(s) { if (!s) return null; const d = new Date(s + 'T00:00:00'), n = new Date(); n.setHours(0, 0, 0, 0); return Math.floor((n - d) / 864e5); }

        // ==================== RENDER ====================
        const GRIP = `<svg viewBox="0 0 24 24" fill="currentColor"><circle cx="9" cy="6" r="1.5"/><circle cx="15" cy="6" r="1.5"/><circle cx="9" cy="12" r="1.5"/><circle cx="15" cy="12" r="1.5"/><circle cx="9" cy="18" r="1.5"/><circle cx="15" cy="18" r="1.5"/></svg>`;
        const CHEV = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`;

        function renderBoard() {
            const st = document.getElementById('searchInput').value.toLowerCase();
            const cols = {
                on_the_road: document.getElementById('col-on-the-road'),
                complaints: document.getElementById('col-complaints'),
                ready:      document.getElementById('col-ready'),
                parts:      document.getElementById('col-parts'),
                progress:   document.getElementById('col-progress'),
                returned:   document.getElementById('col-returned')
            };

            Object.values(cols).forEach(c => c.innerHTML = '');

            const groups = { on_the_road: [], complaints: [], ready: [], parts: [], progress: [], returned: [] };
            
            const getPrioVal = (p) => {
                if (p === 'Urgent') return 0;
                if (p === 'High') return 1;
                if (p === 'Oil Change / Bulb Replacement') return 2;
                return 3;
            };
            const getCondVal = (c) => {
                if (c === 'Down') return 0;
                if (c === 'Warning') return 1;
                return 2;
            };

            const mergedData = {};

            fleetData.forEach(v => {
                if (!v.id) return;
                if (st && !v.id.toLowerCase().includes(st) && !(v.issue || '').toLowerCase().includes(st)) return;

		const colKey = statusToCol(v.shopStatus || "Reported", v.onTheRoad);
                const idKey = v.id.trim().toUpperCase();

                if (!mergedData[colKey]) mergedData[colKey] = {};

                if (!mergedData[colKey][idKey]) {
                    mergedData[colKey][idKey] = {
                        ...v, 
                        tickets: [v] 
                    };
                } else {
                    const master = mergedData[colKey][idKey];
                    master.tickets.push(v);
                    if (getPrioVal(v.priority) < getPrioVal(master.priority)) { master.priority = v.priority; }
                    if (getCondVal(v.status) < getCondVal(master.status)) { master.status = v.status; }
                    if (v.date < master.date) master.date = v.date;
                }
            });

            for (const [colKey, vehicleMap] of Object.entries(mergedData)) {
                groups[colKey] = Object.values(vehicleMap);
            }

            for (const col of Object.keys(groups)) {
    if (col === 'on_the_road') {
        // Sort "On the Road" by inspection date
        groups[col].sort((a, b) => {
            const dateA = a.inspectionDate ? new Date(a.inspectionDate) : new Date('9999-12-31');
            const dateB = b.inspectionDate ? new Date(b.inspectionDate) : new Date('9999-12-31');
            return dateA - dateB;
        });
    } else {
        // Sort other columns by priority
        groups[col].sort((a, b) => {
            const pa = getPrioVal(a.priority);
            const pb = getPrioVal(b.priority);
            if (pa !== pb) return pa - pb; 
            // ... more sort logic (keep existing) ...
        });
    }
}

            let animIdx = 0;
            for (const [colKey, vehicles] of Object.entries(groups)) {
                vehicles.forEach(v => {
                    const tc = cols[colKey];
                    let bc = 'border-' + colKey;
                    let pc = 'pill-' + colKey;
                    let sp = (colKey === 'parts');

                    const prio = v.priority || 'Normal';
                    let prioBadge = '';
                    let prioClass = '';
                    if (prio === 'Urgent') {
                        prioBadge = '<span class="priority-badge pb-urgent">ðŸ”´ URGENT</span>';
                        prioClass = ' priority-urgent';
                    } else if (prio === 'High') {
                        prioBadge = '<span class="priority-badge pb-high">âš  HIGH</span>';
                        prioClass = ' priority-high';
                    } else if (prio === 'Oil Change / Bulb Replacement') {
                        prioBadge = '<span class="priority-badge pb-maint">ðŸ”§ MAINT</span>';
                    }

                    // TYPE BADGE GENERATION
                    const vType = v.vehicleType || '';
                    let typeBadge = '';
                    if(vType) {
                        let tc = 'type-other';
                        if(vType === 'Van') tc = 'type-van';
                        if(vType === 'Prius') tc = 'type-prius';
                        if(vType === 'Scion') tc = 'type-scion';
                        typeBadge = `<span class="type-badge ${tc}">${vType}</span>`;
                    }

                    const cc = v.status === 'Down' ? 'cond-down' : v.status === 'Warning' ? 'cond-warning' : 'cond-operational';
                    
                    const days = daysElapsed(v.date); 
                    let db = '';
                    if (days !== null && v.shopStatus !== "Complete") db = `<span class="days-badge ${days > 14 ? 'crit' : days > 7 ? 'warn' : ''}">${days}d</span>`;

                    const homeLoc = v.homeLocation ? `<span class="card-location">ðŸ  ${v.homeLocation}</span>` : '';

                    let ticketsHtml = '<div class="ticket-list">';
                    v.tickets.forEach(t => {
                        let trClass = '';
                        if(t.priority === 'Urgent') trClass = 'tr-urgent';
                        else if(t.priority === 'High') trClass = 'tr-high';
                        else if(t.priority === 'Oil Change / Bulb Replacement') trClass = 'tr-maint';

                        let reqHtml = '';
                        if(t.requestedBy) {
                            reqHtml = `<div class="req-line"><span>ðŸ‘¤ Req:</span><span class="req-val">${t.requestedBy}</span></div>`;
                        }

                        ticketsHtml += `
                            <div class="ticket-row ${trClass}" onclick="event.stopPropagation(); openModal('edit', ${t.rowIndex})">
                                <div class="ticket-header">
                                    <span class="ticket-issue">${t.issue}</span>
                                </div>
                                ${reqHtml}
                                <div class="ticket-meta">
                                    <span>ðŸ“… ${formatDate(t.date)}</span>
                                    ${t.notes ? '<span>ðŸ“ Note</span>' : ''}
                                </div>
                            </div>
                        `;
                    });
                    ticketsHtml += '</div>';

                    let ph = '';
                    if (sp) { 
                        ph = `<div class="parts-info-block"><div class="parts-row"><span class="parts-label">Ordered</span><span class="parts-val">${formatDate(v.partsOrdered) || 'â€”'}</span></div><div class="parts-row"><span class="parts-label">ETA</span><span class="parts-val eta">${formatDate(v.partsEta) || 'â€”'}</span></div></div>`; 
                    }
                    
                    const allRowIndexes = v.tickets.map(t => t.rowIndex);
                    const ck = String(v.id + '-' + colKey + '-' + animIdx), ic = collapsedCards.has(ck);
                    const card = document.createElement('div');
                    card.className = `vehicle-card ${bc}${prioClass} ${ic ? 'collapsed' : ''}`;
                    card.style.animationDelay = `${Math.min(animIdx * 0.025, 0.3)}s`;
                    card.dataset.cardKey = ck; 
                    card.draggable = colKey !== 'on_the_road' && !isMobile();
                    if (colKey !== 'on_the_road') {
                        card.addEventListener('dragstart', e => onDragStart(e, allRowIndexes));
                        card.addEventListener('dragend', onDragEnd);
                    }
                    
                    let countBadge = v.tickets.length > 1 ? `<span class="multi-tag">${v.tickets.length} Tickets</span>` : '';

                    // Add inspection date badge for on_the_road column
                    let inspectionBadge = '';
                    if (colKey === 'on_the_road' && v.inspectionDate) {
                        const daysUntil = Math.ceil((new Date(v.inspectionDate) - new Date()) / (1000 * 60 * 60 * 24));
                        inspectionBadge = `<span class="inspection-date-badge" style="background:rgba(167,139,250,0.15);color:#a78bfa;">${v.inspectionDate} (${daysUntil}d)</span>`;
                    }

                    card.innerHTML = `
                        <div class="card-top-bar" onclick="toggleCard('${ck}',this.querySelector('.collapse-toggle'))">
                            <div class="card-id-group">
                                <div class="drag-handle" title="Drag">${GRIP}</div>
                                <span class="card-id">${v.id}</span>
                                ${typeBadge}
                                ${countBadge}
                                <span class="card-condition ${cc}">${v.status || ''}</span>
                                ${prioBadge}
                                ${db}
                                ${inspectionBadge}
                            </div>
                            <div class="card-right">
                                <button class="collapse-toggle" onclick="event.stopPropagation();toggleCard('${ck}',this);">${CHEV}</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="card-meta">
                                <span class="card-pill ${pc}">${v.shopStatus || ''}</span>
                                <div class="card-location">ðŸ“ ${v.location || 'Dispatch Lot'}</div>
                            </div>
                            <div class="card-location-row">${homeLoc}</div>
                            ${ticketsHtml}
                            ${ph}
                        </div>`;
                    
                    tc.appendChild(card);
                    animIdx++;
                });
            }
            
            Object.entries(cols).forEach(([key, el]) => {
                if (!el.children.length) el.innerHTML = `<div class="empty-state"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M12 8v8M8 12h8"/></svg><span>No units</span></div>`; 
            });

            document.getElementById('count-col-road').innerText = groups.on_the_road.length;
            document.getElementById('count-col-1').innerText = groups.complaints.length; 
            document.getElementById('count-col-2').innerText = groups.ready.length;
            document.getElementById('count-col-3').innerText = groups.parts.length; 
            document.getElementById('count-col-4').innerText = groups.progress.length;
            document.getElementById('count-col-5').innerText = groups.returned.length;
            
            document.getElementById('kpi-total').innerText = fleetData.length;
            document.getElementById('kpi-parts').innerText = groups.parts.length;
            document.getElementById('kpi-complete').innerText = groups.returned.length;
            document.getElementById('kpi-ready').innerText = groups.ready.length;

            if (isMobile()) updateSwiperUI();
        }

        function toggleCard(k, b) { const c = b.closest('.vehicle-card'); if (collapsedCards.has(k)) { collapsedCards.delete(k); c.classList.remove('collapsed'); } else { collapsedCards.add(k); c.classList.add('collapsed'); } }
        function toggleCollapseAll(id) { const c = document.getElementById(id), cards = c.querySelectorAll('.vehicle-card'), all = [...cards].every(c => c.classList.contains('collapsed')); cards.forEach(card => { const k = card.dataset.cardKey; if (all) { collapsedCards.delete(k); card.classList.remove('collapsed'); } else { collapsedCards.add(k); card.classList.add('collapsed'); } }); }
        function toggleColumnCollapse(btn) {
            const column = btn.closest('.kanban-column');
            const wasCollapsed = column.classList.contains('collapsed-column');
            column.classList.toggle('collapsed-column');
            btn.textContent = wasCollapsed ? 'âˆ’' : '+';
        }

        function togglePartsFields() { 
            const s = document.getElementById('vShopStatus').value;
            const sec = document.getElementById('partsSection');
            const o = document.getElementById('vPartsOrdered');
            const e = document.getElementById('vPartsEta');
            
            if (s === "Awaiting part order") { 
                sec.style.display = "block"; 
                o.required = false; 
                e.required = false; 
            } else { 
                sec.style.display = "none"; 
                o.required = false; 
                e.required = false; 
            } 
        }

        function openModal(mode, ri = null) {
            document.getElementById('entryModal').style.display = 'flex'; 
            document.getElementById('mode').value = mode; 
            const d = document.getElementById('deleteBtn');
            
            // Set User name from storage
            const storedUser = localStorage.getItem('dlx_username');
            if(storedUser) document.getElementById('currentUser').value = storedUser;

            if (mode === 'add') {
                document.getElementById('modalTitle').innerText = "ADD NEW UNIT"; 
                document.getElementById('vehicleForm').reset();
                if(storedUser) document.getElementById('currentUser').value = storedUser; // re-set after reset

                document.getElementById('vID').readOnly = false; 
                document.getElementById('vDate').valueAsDate = new Date();
                document.getElementById('vPriority').value = 'Normal'; 
                document.getElementById('vHomeLocation').value = '';
                document.getElementById('vNotes').value = '';
                document.getElementById('vRequestedBy').value = '';
                document.getElementById('vType').value = '';
                document.getElementById('vHistory').value = '';
                document.getElementById('historyList').innerHTML = '<div style="color:var(--text-muted);text-align:center;">New ticket - no history</div>';
                d.style.display = 'none'; 
                togglePartsFields();
            } else {
                document.getElementById('modalTitle').innerText = "EDIT UNIT"; 
                d.style.display = 'block';
                const v = fleetData.find(v => v.rowIndex === ri);
                if (v) {
                    document.getElementById('targetRowIndex').value = v.rowIndex;
                    document.getElementById('vID').value = v.id; 
                    document.getElementById('vStatus').value = v.status;
                    document.getElementById('vIssue').value = v.issue; 
                    document.getElementById('vDate').value = v.date;
                    document.getElementById('vInspectionDate').value = v.inspectionDate || "";
                    document.getElementById('vShopStatus').value = v.shopStatus;
                    document.getElementById('vLocation').value = v.location || "Dispatch Lot";
                    document.getElementById('vPartsOrdered').value = v.partsOrdered || "";
                    document.getElementById('vPartsEta').value = v.partsEta || "";
                    document.getElementById('vPriority').value = v.priority || "Normal";
                    document.getElementById('vHomeLocation').value = v.homeLocation || "";
                    document.getElementById('vNotes').value = v.notes || "";
                    document.getElementById('vRequestedBy').value = v.requestedBy || "";
                    document.getElementById('vType').value = v.vehicleType || "";
                    document.getElementById('vOnTheRoad').checked = v.onTheRoad === true;

                    document.getElementById('vHistory').value = v.history || "";
                    const hist = parseHistory(v.history);
                    renderHistoryLog(hist);
                    
                    // Show last updated info
                    if(hist.length > 0) {
                        const last = hist[hist.length-1];
                        document.getElementById('lastUpdatedBy').textContent = `Last: ${last.user}`;
                    } else {
                        document.getElementById('lastUpdatedBy').textContent = '';
                    }

                    togglePartsFields();
                }
            }
        }
        function closeModal() { document.getElementById('entryModal').style.display = 'none'; }
        
        function saveVehicle(e) { 
            e.preventDefault(); 
            const b = document.getElementById('saveBtn'), m = document.getElementById('mode').value;
            const oldRi = document.getElementById('targetRowIndex').value;
            
            // Gather Form Data
            const id = document.getElementById('vID').value;
            const status = document.getElementById('vStatus').value;
            const issue = document.getElementById('vIssue').value;
            const date = document.getElementById('vDate').value;
            const shopStatus = document.getElementById('vShopStatus').value;
            const location = document.getElementById('vLocation').value;
            const partsOrdered = document.getElementById('vPartsOrdered').value;
            const partsEta = document.getElementById('vPartsEta').value;
            const priority = document.getElementById('vPriority').value;
            const homeLocation = document.getElementById('vHomeLocation').value;
            const notes = document.getElementById('vNotes').value;
            const requestedBy = document.getElementById('vRequestedBy').value;
            const vehicleType = document.getElementById('vType').value;
            const rawHist = document.getElementById('vHistory').value;
		const onTheRoad = document.getElementById('vOnTheRoad').checked;

            // --- AUDIT LOGIC ---
            let historyArr = parseHistory(rawHist);
            
            if (m === 'add') {
                historyArr.push(createLogEntry('Created', 'Ticket created'));
            } else {
                // Find old data to compare
                const oldV = fleetData.find(v => v.rowIndex == oldRi);
                if(oldV) {
                    if(oldV.shopStatus !== shopStatus) historyArr.push(createLogEntry('Status', `Changed to ${shopStatus}`));
                    if(oldV.priority !== priority) historyArr.push(createLogEntry('Priority', `Changed to ${priority}`));
                    if(oldV.notes !== notes && notes.length > (oldV.notes||'').length) historyArr.push(createLogEntry('Note', 'Note added/updated'));
                    if(oldV.partsEta !== partsEta) historyArr.push(createLogEntry('ETA', `ETA: ${partsEta}`));
                }
            }

            const user = getUsername();
            
            const p = { 
    action: m === 'edit' ? 'update' : 'add', 
    rowIndex: oldRi, 
    user: user,
    id, status, issue, date, inspectionDate: document.getElementById('vInspectionDate').value, shopStatus, location, partsOrdered, partsEta, priority, homeLocation, notes, requestedBy, vehicleType, onTheRoad,  // â† ADD onTheRoad
    history: JSON.stringify(historyArr)
};

            b.innerText = "SAVINGâ€¦"; b.disabled = true; 
            fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(p) })
                .then(() => { 
                    closeModal(); 
                    b.innerText = "SAVE"; 
                    b.disabled = false; 
                    showToast("âœ“ Saved by " + user); 
                    setTimeout(fetchSheetData, 1000); 
                })
                .catch(err => {
                    console.error("Save failed:", err);
                    b.innerText = "SAVE"; 
                    b.disabled = false;
                    showToast("âŒ Failed to save - check connection");
                });
        }

        function deleteCurrent() { 
            if (!confirm("Delete this vehicle?")) return; 
            const ri = document.getElementById('targetRowIndex').value;
            const b = document.getElementById('deleteBtn');
            const user = getUsername();
            
            b.innerText = "DELETINGâ€¦"; 
            fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "delete", rowIndex: ri, user: user }) })
                .then(() => { 
                    closeModal(); 
                    b.innerText = "DELETE"; 
                    showToast("ðŸ—‘ Deleted by " + user); 
                    setTimeout(fetchSheetData, 1000); 
                })
                .catch(err => { 
                    console.error("Delete failed:", err); 
                    b.innerText = "DELETE"; 
                    showToast("âŒ Failed to delete"); 
                }); 
        }

        // ==================== BULLETIN ====================
        let bulletinMessages = [];
        function loadBulletin() { try { bulletinMessages = JSON.parse(localStorage.getItem('dlx_bulletin_messages')) || []; } catch { bulletinMessages = []; } const sa = localStorage.getItem('dlx_bulletin_author'); if (sa) document.getElementById('msgAuthor').value = sa; renderBulletin(); updateBadge(); }
        function saveBulletin() { localStorage.setItem('dlx_bulletin_messages', JSON.stringify(bulletinMessages)); }
        function toggleBulletin() { const p = document.getElementById('bulletinPanel'), o = document.getElementById('bulletinOverlay'); if (p.classList.contains('open')) { p.classList.remove('open'); o.classList.remove('open'); } else { p.classList.add('open'); o.classList.add('open'); document.getElementById('bulletinToggle').classList.remove('has-new'); localStorage.setItem('dlx_bulletin_seen', String(bulletinMessages.length)); updateBadge(); } }
        function updateBadge() { const seen = parseInt(localStorage.getItem('dlx_bulletin_seen') || '0'), unseen = Math.max(0, bulletinMessages.length - seen), badge = document.getElementById('msgCount'), btn = document.getElementById('bulletinToggle'); if (unseen > 0) { badge.textContent = unseen; badge.style.display = 'inline-block'; btn.classList.add('has-new'); } else { badge.style.display = 'none'; btn.classList.remove('has-new'); } }
        function postMessage() { const a = document.getElementById('msgAuthor').value.trim(), body = document.getElementById('msgBody').value.trim(), pr = document.getElementById('msgPriority').value; if (!body) return; bulletinMessages.unshift({ id: Date.now() + '_' + Math.random().toString(36).substr(2, 5), author: a || 'Anonymous', body, priority: pr, time: new Date().toISOString(), pinned: false }); saveBulletin(); localStorage.setItem('dlx_bulletin_author', bulletinMessages[0].author); localStorage.setItem('dlx_bulletin_seen', String(bulletinMessages.length)); document.getElementById('msgBody').value = ''; document.getElementById('postBtn').disabled = true; renderBulletin(); showToast("ðŸ“Œ Posted"); }
        function deleteMessage(id) { bulletinMessages = bulletinMessages.filter(m => m.id !== id); saveBulletin(); renderBulletin(); updateBadge(); }
        function togglePin(id) { const m = bulletinMessages.find(m => m.id === id); if (m) { m.pinned = !m.pinned; saveBulletin(); renderBulletin(); } }
        function formatRelativeTime(iso) { const diff = Math.floor((new Date() - new Date(iso)) / 1000); if (diff < 60) return 'just now'; if (diff < 3600) return Math.floor(diff / 60) + 'm ago'; if (diff < 86400) return Math.floor(diff / 3600) + 'h ago'; if (diff < 604800) return Math.floor(diff / 86400) + 'd ago'; return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
        function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
        function renderBulletin() { const f = document.getElementById('bulletinFeed'); if (!bulletinMessages.length) { f.innerHTML = `<div class="bulletin-empty"><div style="font-size:2rem;opacity:0.3;margin-bottom:0.5rem">ðŸ“‹</div><div style="font-size:0.85rem">No messages yet</div><div style="font-size:0.7rem;color:#444;margin-top:0.3rem">Post an update for the team</div></div>`; return; } const sorted = [...bulletinMessages].sort((a, b) => (a.pinned && !b.pinned) ? -1 : (!a.pinned && b.pinned) ? 1 : 0); f.innerHTML = sorted.map(m => `<div class="bulletin-msg ${m.pinned ? 'pinned' : ''}"><div class="bulletin-msg-header"><div class="bulletin-msg-author">${escapeHtml(m.author)}<span class="bpriority-tag bpriority-${m.priority}">${m.priority.replace('-', ' ')}</span>${m.pinned ? '<span style="color:var(--c-bulletin);font-size:0.7rem">ðŸ“Œ</span>' : ''}</div><span class="bulletin-msg-time">${formatRelativeTime(m.time)}</span></div><div class="bulletin-msg-body">${escapeHtml(m.body)}</div><button class="pin-btn ${m.pinned ? 'is-pinned' : ''}" onclick="togglePin('${m.id}')">ðŸ“Œ</button><button class="bulletin-msg-delete" onclick="deleteMessage('${m.id}')">âœ•</button></div>`).join(''); }
        document.getElementById('msgBody').addEventListener('input', function () { document.getElementById('postBtn').disabled = !this.value.trim(); });
        document.getElementById('msgBody').addEventListener('keydown', function (e) { if (e.key === 'Enter' && (e.ctrlKey || e.metaKey) && this.value.trim()) postMessage(); });

        // ==================== UTILITIES ====================
        function showToast(msg) { document.querySelectorAll('.toast').forEach(e => e.remove()); const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; document.body.appendChild(t); setTimeout(() => t.remove(), 3000); }
        function toggleTheme() { document.body.classList.toggle('light-mode'); }
        function toggleWallboardMode() { document.body.classList.toggle('wallboard-mode'); }
        document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeModal(); if (document.getElementById('bulletinPanel').classList.contains('open')) toggleBulletin(); } });

        initSwiperDots();
        fetchSheetData(); setInterval(fetchSheetData, 30000); loadBulletin();
    </script>
</body>
</html>
